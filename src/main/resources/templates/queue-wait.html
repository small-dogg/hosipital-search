<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <title>Queue Wait</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>

<h2>대기열 화면</h2>

<div>
    <div>encId: <span id="encId" th:text="${encId}"></span></div>
    <div>ticketId: <span id="ticketId" th:text="${ticketId}"></span></div>
    <div>status: <span id="status">-</span></div>
    <div>position: <span id="position">-</span></div>
    <div>readyDeadlineAt: <span id="deadline">-</span></div>
</div>

<hr/>

<div id="actionArea" style="display:none;">
    <a id="enterLink" href="#">예약 시스템으로 진입</a>
</div>

<script th:inline="javascript">
    const encId = /*[[${encId}]]*/ "";
    const ticketId = /*[[${ticketId}]]*/ "";

    const socket = new SockJS("/ws");
    const stomp = Stomp.over(socket);
    stomp.debug = null; // 로그 끄기

    stomp.connect({}, function () {
        const dest = `/topic/queue/${encId}/${ticketId}`;
        stomp.subscribe(dest, function (frame) {
            const msg = JSON.parse(frame.body);

            document.getElementById("status").innerText = msg.status ?? "-";
            document.getElementById("position").innerText = msg.position ?? "-";
            document.getElementById("deadline").innerText = msg.readyDeadlineAt ?? "-";

            if (msg.status === "READY" && msg.enterUrl) {
                document.getElementById("actionArea").style.display = "block";
                const a = document.getElementById("enterLink");
                a.href = msg.enterUrl;
            }
        });
    });
</script>

</body>
</html>
