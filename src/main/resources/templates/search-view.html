<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë³‘ì› ê²€ìƒ‰</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            max-width: 700px;
            margin: 40px auto;
            padding: 0 16px;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 16px;
        }

        .search-container {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        #keyword {
            flex: 1;
            padding: 10px 12px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }

        #search-btn {
            padding: 10px 18px;
            background-color: #1e88e5;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }

        #search-btn:hover {
            background-color: #1565c0;
        }

        /* ìë™ì™„ì„± ìŠ¤íƒ€ì¼ */
        .suggestions {
            border: 1px solid #ddd;
            background: #fff;
            border-radius: 8px;
            max-height: 240px;
            overflow-y: auto;
            margin-top: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
        }
        .suggestions.hidden {
            display: none;
        }
        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #f5f5f5;
        }
        .empty-message {
            padding: 8px 12px;
            color: #888;
            font-size: 14px;
        }

        /* ê²€ìƒ‰ ê²°ê³¼ ì¹´ë“œ */
        .results {
            margin-top: 24px;
        }

        .hospital-card {
            padding: 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 12px;
            background: #fafafa;
        }

        .hospital-name {
            font-size: 18px;
            font-weight: bold;
        }

        .hospital-address,
        .hospital-phone,
        .hospital-zip {
            margin-top: 4px;
            font-size: 14px;
            color: #444;
        }

        /* ì§€ë„ ì˜ì—­ */
        #map {
            margin-top: 16px;
            width: 100%;
            height: 400px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
    </style>

    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=991885abf04e8102d5e4a0358a7f481b"></script>
</head>

<body>
<h1>ë³‘ì› ê²€ìƒ‰</h1>

<div class="search-container">
    <input id="keyword" type="text" placeholder="ë³‘ì›ëª… ì…ë ¥ (ì˜ˆ: ê°•ë‚¨, ì†Œì•„, ì„¸ë¸Œë€ìŠ¤)">
    <button id="search-btn">ê²€ìƒ‰</button>
</div>

<!-- ìë™ì™„ì„± -->
<div id="suggestions" class="suggestions hidden"></div>

<!-- ê²€ìƒ‰ ê²°ê³¼ -->
<div id="results" class="results"></div>

<!-- ì§€ë„ -->
<div id="map"></div>

<script>
    const input = document.getElementById('keyword');
    const suggestionsBox = document.getElementById('suggestions');
    const searchBtn = document.getElementById('search-btn');
    const resultsBox = document.getElementById('results');

    let timerId = null;
    const DEBOUNCE_MS = 300;

    let currentIndex = -1;  // ìë™ì™„ì„± ì„ íƒ ì¸ë±ìŠ¤
    let suggestions = [];   // í˜„ì¬ ìë™ì™„ì„± ëª©ë¡

    // ì§€ë„ ê´€ë ¨
    let map;
    let markers = [];

    /* -------------------------
       ì§€ë„ ì´ˆê¸°í™”
    -------------------------- */
    function initMap() {
        const container = document.getElementById('map');
        if (!container || !window.kakao || !kakao.maps) {
            return;
        }

        const options = {
            center: new kakao.maps.LatLng(37.5665, 126.9780), // ì„œìš¸ ê¸°ì¤€
            level: 8
        };

        map = new kakao.maps.Map(container, options);
    }

    window.addEventListener('load', initMap);

    /* -------------------------
       ìë™ì™„ì„± ì…ë ¥ ì²˜ë¦¬
    -------------------------- */
    input.addEventListener('input', () => {
        const q = input.value.trim();
        currentIndex = -1;

        if (timerId) clearTimeout(timerId);

        if (q.length === 0) {
            hideSuggestions();
            return;
        }

        timerId = setTimeout(() => fetchAutoComplete(q), DEBOUNCE_MS);
    });

    /* -------------------------
       ìë™ì™„ì„± API í˜¸ì¶œ
       /api/v1/search/autocomplete/{keyword}
    -------------------------- */
    function fetchAutoComplete(keyword) {
        fetch(`/api/v1/search/autocomplete/${encodeURIComponent(keyword)}`)
            .then(res => res.json())
            .then(data => {
                suggestions = data || [];
                renderSuggestions(suggestions);
            })
            .catch(() => hideSuggestions());
    }

    /* -------------------------
       ìë™ì™„ì„± ë Œë”ë§
    -------------------------- */
    function renderSuggestions(list) {
        suggestionsBox.innerHTML = "";
        currentIndex = -1;

        if (!list || list.length === 0) {
            const div = document.createElement("div");
            div.className = "empty-message";
            div.textContent = "ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ";
            suggestionsBox.appendChild(div);
            suggestionsBox.classList.remove("hidden");
            return;
        }

        list.forEach((item) => {
            const div = document.createElement("div");
            div.className = "suggestion-item";
            div.textContent = item.name;

            div.addEventListener("click", () => {
                input.value = item.name;
                hideSuggestions();
            });

            suggestionsBox.appendChild(div);
        });

        suggestionsBox.classList.remove("hidden");
    }

    function hideSuggestions() {
        suggestionsBox.classList.add("hidden");
        suggestionsBox.innerHTML = "";
        currentIndex = -1;
    }

    /* -------------------------
       ìë™ì™„ì„± ì„ íƒ í•˜ì´ë¼ì´íŠ¸
    -------------------------- */
    function updateHighlight() {
        const items = document.querySelectorAll(".suggestion-item");
        items.forEach((item, i) => {
            if (i === currentIndex) {
                item.style.background = "#e3f2fd";
            } else {
                item.style.background = "white";
            }
        });
    }

    /* -------------------------
       í‚¤ë³´ë“œ ì´ë²¤íŠ¸
       - ArrowUp / ArrowDown: ìë™ì™„ì„± ì´ë™
       - Enter: ì„ íƒ + ê²€ìƒ‰ ì‹¤í–‰
       - ESC: ìë™ì™„ì„± ë‹«ê¸°
    -------------------------- */
    input.addEventListener("keydown", (event) => {
        const items = document.querySelectorAll(".suggestion-item");

        if (event.key === "ArrowDown") {
            event.preventDefault();
            if (items.length > 0) {
                currentIndex = (currentIndex + 1) % items.length;
                updateHighlight();
            }
        }

        if (event.key === "ArrowUp") {
            event.preventDefault();
            if (items.length > 0) {
                currentIndex = currentIndex <= 0 ? items.length - 1 : currentIndex - 1;
                updateHighlight();
            }
        }

        if (event.key === "Enter") {
            event.preventDefault();

            // ìë™ì™„ì„±ì—ì„œ ì„ íƒëœ í•­ëª©ì´ ìˆë‹¤ë©´ ì…ë ¥ì°½ì— ë°˜ì˜
            if (currentIndex >= 0 && suggestions[currentIndex]) {
                input.value = suggestions[currentIndex].name;
                hideSuggestions();
            }

            // ê²€ìƒ‰ ì‹¤í–‰
            searchBtn.click();
        }

        if (event.key === "Escape") {
            hideSuggestions();
        }
    });

    /* -------------------------
       ê²€ìƒ‰ ë²„íŠ¼ â†’ ë³‘ì› ê²€ìƒ‰ API í˜¸ì¶œ
       (ì˜ˆ: GET /api/v1/search/{keyword})
    -------------------------- */
    searchBtn.addEventListener("click", () => {
        const keyword = input.value.trim();
        if (keyword === "") return;

        fetch(`/api/v1/search/${encodeURIComponent(keyword)}`)
            .then(res => res.json())
            .then(data => renderSearchResults(data))
            .catch(err => console.error(err));
    });

    /* -------------------------
       ë³‘ì› ê²€ìƒ‰ ê²°ê³¼ ë Œë”ë§
       (List<SearchHospitalResult>)
    -------------------------- */
    function renderSearchResults(list) {
        resultsBox.innerHTML = "";

        if (!list || list.length === 0) {
            resultsBox.innerHTML = "<p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
            renderMap([]); // ì§€ë„ë„ ë¹„ì›€
            return;
        }

        list.forEach(h => {
            const card = document.createElement("div");
            card.className = "hospital-card";

            card.innerHTML = `
                <div class="hospital-name">${h.name}</div>
                <div class="hospital-address">ğŸ“ ${h.address || ''}</div>
                <div class="hospital-phone">â˜ ${h.phone || 'ì •ë³´ ì—†ìŒ'}</div>
                <div class="hospital-zip">ìš°í¸ë²ˆí˜¸: ${h.zip || '-'}</div>
            `;

            resultsBox.appendChild(card);
        });

        // ì§€ë„ì— ë§ˆì»¤ í‘œì‹œ
        renderMap(list);
    }

    /* -------------------------
       ì§€ë„ì— ë§ˆì»¤ í‘œì‹œ
    -------------------------- */
    function renderMap(hospitals) {
        if (!map) return;

        // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
        markers.forEach(m => m.setMap(null));
        markers = [];

        if (!hospitals || hospitals.length === 0) {
            return;
        }

        const bounds = new kakao.maps.LatLngBounds();

        hospitals.forEach(h => {
            if (!h.location || h.location.lat == null || h.location.lon == null) {
                return;
            }

            const lat = h.location.lat;
            const lon = h.location.lon;

            const pos = new kakao.maps.LatLng(lat, lon);
            const marker = new kakao.maps.Marker({
                position: pos
            });

            marker.setMap(map);
            markers.push(marker);
            bounds.extend(pos);
        });

        if (!bounds.isEmpty()) {
            map.setBounds(bounds);
        }
    }
</script>

</body>
</html>
